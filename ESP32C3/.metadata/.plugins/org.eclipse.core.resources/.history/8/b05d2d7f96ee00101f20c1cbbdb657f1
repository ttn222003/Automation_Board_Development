/*
 * UartDriver.c
 *
 *  Created on: Jan 2, 2026
 *      Author: TTN
 */

#include "UartDriver.h"

/*------- Struct -------*/
typedef struct
{
	uart_port_t port_num;
	gpio_num_t txd;
	gpio_num_t rxd;
	int rts;
	int cts;
} uart_pin_t;

typedef struct
{
	QueueHandle_t mUartQueue;
	uart_config_t mUartConfig;
	uart_pin_t mUartPin;
} UartDriver_t;
/*--------------*/

/*------- Private variable -------*/
static UartDriver_t mUartDriverArray[UART_MAX_INSTANCE];
static uint8_t mUartUsed[UART_MAX_INSTANCE];

UartHandle_t UartCreate(void)
{
	for(uint8_t i = 0; i < UART_MAX_INSTANCE; i++)
	{
		if(!mUartUsed[i])
		{
			mUartUsed[i] = 1;
			return &mUartDriverArray[i];
		}
	}
	
	return NULL;
}

void InitializeUartParameter(UartHandle_t uart_handle,\
							uint32_t baudrate,\
							uart_word_length_t uart_data_bits,\
							uart_parity_t uart_parity,\
							uart_stop_bits_t uart_stop_bits,\
							uart_hw_flowcontrol_t uart_hw_flowcontrol,\
							soc_periph_uart_clk_src_legacy_t uart_src_clock)
{
	uart_driver->mUartConfig.baud_rate = baudrate;
	uart_driver->mUartConfig.data_bits = uart_data_bits;
	uart_driver->mUartConfig.parity = uart_parity;
	uart_driver->mUartConfig.stop_bits = uart_stop_bits;
	uart_driver->mUartConfig.flow_ctrl = uart_hw_flowcontrol;
	uart_driver->mUartConfig.source_clk = uart_src_clock;
}

void InitializeUartPin(UartDriver_t* uart_driver, uart_port_t port_num, gpio_num_t tx_pin, gpio_num_t rx_pin, int rts_pin, int cts_pin)
{
	uart_driver->mUartPin.port_num = port_num;
	uart_driver->mUartPin.txd = tx_pin;
	uart_driver->mUartPin.rxd = rx_pin;
	uart_driver->mUartPin.rts = rts_pin;
	uart_driver->mUartPin.cts = cts_pin;
}

void InitializeUart(UartDriver_t* uart_driver, uint16_t tx_buffer_size, uint16_t rx_buffer_size, uint8_t queue_size, uint8_t interrupt_allocate_flag)
{
    uart_driver_install(uart_driver->mUartPin.port_num, rx_buffer_size, tx_buffer_size, queue_size, &uart_driver->mUartQueue, interrupt_allocate_flag);
    uart_param_config(uart_driver->mUartPin.port_num, &uart_driver->mUartConfig);
    uart_set_pin(uart_driver->mUartPin.port_num, uart_driver->mUartPin.txd, uart_driver->mUartPin.rxd, uart_driver->mUartPin.rts, uart_driver->mUartPin.cts);
}

void UartTransmittOneByteData(UartDriver_t uart_driver, uint8_t transmitted_data)
{
	uart_write_bytes(uart_driver.mUartPin.port_num, &transmitted_data, 1);
}