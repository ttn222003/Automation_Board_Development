/*
 * UartDriver.c
 *
 *  Created on: Jan 2, 2026
 *      Author: TTN
 */

#include "UartDriver.h"
#include "driver/uart.h"
#include <stdint.h>

/*------- Struct -------*/
typedef struct
{
	uart_port_t port_num;
	gpio_num_t txd;
	gpio_num_t rxd;
	int rts;
	int cts;
} uart_pin_t;

typedef struct
{
	uart_config_t mUartConfig;
	QueueHandle_t mQueueHandle;
	uart_event_t mUartEvent;
	uart_pin_t mUartPin;
} UartDriver_t;
/*--------------*/

/*------- Private variable -------*/
static UartDriver_t mUartDriverArray[UART_MAX_INSTANCE];
static uint8_t mUartUsed[UART_MAX_INSTANCE];

UartHandle_t UartCreate(void)
{
	for(uint8_t i = 0; i < UART_MAX_INSTANCE; i++)
	{
		if(!mUartUsed[i])
		{
			mUartUsed[i] = 1;
			return &mUartDriverArray[i];
		}
	}
	
	return NULL;
}

void InitializeUartParameter(UartHandle_t uart_handle, uint32_t baudrate, uint8_t uart_data_bits, uint8_t uart_parity, uint8_t uart_stop_bits, uint8_t uart_hw_flowcontrol, uint8_t uart_src_clock)
{
	UartDriver_t* uart_driver = (UartDriver_t*)uart_handle;
	
	if(uart_driver == NULL)
	{
		return;
	}
	
	uart_driver->mUartConfig.baud_rate = baudrate;
	uart_driver->mUartConfig.data_bits = (uart_word_length_t)uart_data_bits;
	uart_driver->mUartConfig.parity = (uart_parity_t)uart_parity;
	uart_driver->mUartConfig.stop_bits = (uart_stop_bits_t)uart_stop_bits;
	uart_driver->mUartConfig.flow_ctrl = (uart_hw_flowcontrol_t)uart_hw_flowcontrol;
	uart_driver->mUartConfig.source_clk = (soc_periph_uart_clk_src_legacy_t)uart_src_clock;
}

void InitializeUartPin(UartHandle_t uart_handle, uint8_t port_num, uint8_t tx_pin, uint8_t rx_pin, int rts_pin, int cts_pin)
{
	UartDriver_t* uart_driver = (UartDriver_t*)uart_handle;
	
	if(uart_driver == NULL)
	{
		return;
	}
	
	uart_driver->mUartPin.port_num = (uart_port_t)port_num;
	uart_driver->mUartPin.txd = (gpio_num_t)tx_pin;
	uart_driver->mUartPin.rxd = (gpio_num_t)rx_pin;
	uart_driver->mUartPin.rts = rts_pin;
	uart_driver->mUartPin.cts = cts_pin;
}

void InitializeUart(UartHandle_t uart_handle, uint16_t tx_buffer_size, uint16_t rx_buffer_size, uint8_t queue_size, uint8_t interrupt_allocate_flag)
{
	UartDriver_t* uart_driver = (UartDriver_t*)uart_handle;
	
	if(uart_driver == NULL)
	{
		return;
	}
	
    uart_driver_install(uart_driver->mUartPin.port_num, rx_buffer_size, tx_buffer_size, queue_size, &uart_driver->mQueueHandle, interrupt_allocate_flag);
    uart_param_config(uart_driver->mUartPin.port_num, &uart_driver->mUartConfig);
    uart_set_pin(uart_driver->mUartPin.port_num, uart_driver->mUartPin.txd, uart_driver->mUartPin.rxd, uart_driver->mUartPin.rts, uart_driver->mUartPin.cts);
}

void UartTransmittOneByteData(UartHandle_t uart_handle, uint8_t transmitted_data)
{
	UartDriver_t* uart_driver = (UartDriver_t*)uart_handle;
	
	if(uart_driver == NULL)
	{
		return;
	}
	
	uart_write_bytes(uart_driver->mUartPin.port_num, &transmitted_data, 1);
}

int UartQueueReceive(UartHandle_t uart_handle, uint32_t delay_timeout)
{
	UartDriver_t* uart_driver = (UartDriver_t*)uart_handle;
	
	if(uart_driver == NULL)
	{
		return -1;
	}
	
	return xQueueReceive(uart_driver->mQueueHandle, &uart_driver->mUartEvent, delay_timeout);
}

void UartReceiveOneByteData(UartHandle_t uart_handle, uint8_t* received_data)
{
	UartDriver_t* uart_driver = (UartDriver_t*)uart_handle;
	
	if(uart_driver == NULL)
	{
		return;
	}
	
	uart_read_bytes(uart_driver->mUartPin.port_num, received_data, 1, 1);
}